<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>ЭкоНива · Калькулятор сделки</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--green:#009639;--greenD:#0b6e2b;--bg:#f5f8f5;--ink:#1f2937;--muted:#6b7280;--line:#e5e7eb;--edit:#fff6bf;--card:#fff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.header{background:linear-gradient(90deg,var(--green),#0ea76a);color:#fff;padding:16px 18px;display:flex;gap:12px;align-items:center;justify-content:space-between}
.header h1{font-size:18px;margin:0}
.header .buttons{display:flex;gap:8px}
.container{max-width:1200px;margin:18px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
.block{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.block .head{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;justify-content:space-between;align-items:center}
.block .head h2{margin:0;font-size:15px}
.block .body{padding:12px 14px}
.table-wrap{overflow:auto;max-height:360px;border:1px solid var(--line);border-radius:10px}
table{width:100%;border-collapse:collapse;table-layout:auto}
th,td{border:1px solid var(--line);padding:8px 10px;vertical-align:middle}
th{background:#f9fafb;text-align:center;font-weight:700}
td.label{background:#fbfffb;font-weight:600;white-space:nowrap}
input.cell{width:100%;padding:7px 9px;border:1px solid #cbd5e1;border-radius:8px;background:var(--edit);text-align:right;font:inherit}
input.cell.text{text-align:left}
input.cell[type=number]{step:0.01}
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.kpi{background:#f7fff9;border:1px solid #d9f2e2;border-radius:10px;padding:10px 12px}
.kpi.full-width{grid-column:1 / span 2}
.kpi .name{font-size:12px;color:var(--muted)}
.kpi .val{font-size:20px;font-weight:800;color:var(--greenD);word-break:break-all}
.details .table-wrap{max-height:520px}
.sum-row td{background:#f2fff5;font-weight:800}
@media (max-width:980px){.grid{grid-template-columns:1fr}.kpis{grid-template-columns:1fr}.kpi.full-width{grid-column:1}}
</style>
</head>
<body>
  <div class="header">
    <h1>ЭкоНива · Калькулятор импортной сделки</h1>
    <div class="buttons">
      <button onclick="exportToPDF()">Экспорт в PDF</button>
      <button onclick="resetDefaults()">Сбросить</button>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <section class="block">
        <div class="head"><h2>1) Ввод данных</h2></div>
        <div class="body"><div class="table-wrap"><table id="inputsTable">
          <thead><tr><th>Показатель</th><th>C</th><th>D</th><th>E</th><th>F</th><th>G</th></tr></thead>
          <tbody id="inputsBody"></tbody>
        </table></div></div>
      </section>
      <section class="block">
        <div class="head"><h2>2) Результат и главные показатели</h2></div>
        <div class="body"><div id="kpis" class="kpis"></div></div>
      </section>
    </div>
    <section class="block details" style="margin-top:16px">
      <div class="head"><h2>3) Детализация расчёта (только чтение)</h2><button id="toggleDetails">Свернуть</button></div>
      <div class="body" id="detailsBody"><div class="table-wrap"><table id="calc">
        <thead id="thead"></thead><tbody id="tbody"></tbody>
      </table></div></div>
    </section>
  </div>

<script>
/* === Модель === */
const model = {
  rows:[3,4,5,40,41,52,53],
  rowLabels:{
    3:"Наименование товара",4:"Цена FOB, $/t",5:"Стоимость партии FOB, $",
    40:"Себестоимость в порту (РФ), USD/t",41:"Себестоимость на складе в РФ, USD/t",
    52:"Продажа в порту (РФ), руб/т с НДС",53:"Продажа со склада в РФ, руб/т с НДС"
  },
  inputs:["C3","C4","C5","C40","C41","F52","F53"],
  inputRows:[3,4,5,40,41,52,53],
  constants:{},
  kpis:{
    "Наименование товара":"C3",
    "Цена FOB, $/t":"C4",
    "Стоимость партии FOB, $":"C5",
    "Себестоимость в порту (РФ), USD/t":"C40",
    "Себестоимость на складе в РФ, USD/t":"C41",
    "Прибыль от Продажи в порту (РФ), руб/т с НДС":"F52",
    "Прибыль от Продажи со склада в РФ , руб/т с НДС":"F53"
  },
  textInputs:["C3"]
};

/* === Логика === */
const inputs = new Set(model.inputs);
const textInputs = new Set(model.textInputs||[]);
let state = {...model.constants};
const inputRows = new Set(model.inputRows||model.rows);
const inputsBody = document.getElementById('inputsBody');

for (const r of model.rows){
  if (!inputRows.has(r)) continue;
  const tr = document.createElement('tr');
  const tdLabel = document.createElement('td');
  tdLabel.className='label';
  tdLabel.textContent = model.rowLabels[r]||'';
  tr.appendChild(tdLabel);

  for (const col of ["C","D","E","F","G"]){
    const addr = col+r;
    const td = document.createElement('td'); td.className='value';
    if (inputs.has(addr)){
      const isText = textInputs.has(addr);
      const inp = document.createElement('input');
      inp.className='cell'+(isText?' text':'');
      inp.type = isText? 'text' : 'number';
      if (!isText){ inp.step='0.01'; inp.inputMode='decimal'; }
      inp.value = state[addr] ?? '';
      inp.dataset.addr = addr;
      inp.addEventListener('input', ()=>{ state[addr] = isText? inp.value : (inp.value===''? null : Number(inp.value)); drawKpis(); updateCalcValues(); autosizeC(); });
      td.appendChild(inp);
    } else {
      td.innerHTML = `<span class="cell" data-addr="${addr}">${format(state[addr])}</span>`;
    }
    tr.appendChild(td);
  }
  inputsBody.appendChild(tr);
}

// детализация
const thead = document.getElementById('thead');
thead.innerHTML = '<tr><th>Показатель</th><th>C</th><th>D</th><th>E</th><th>F</th><th>G</th></tr>';
const tbody = document.getElementById('tbody');
for (const r of model.rows){
  const tr = document.createElement('tr');
  const label = model.rowLabels[r]||'';
  tr.innerHTML = `
    <td class="label">${label}</td>
    <td class="value"><span class="cell" data-addr="C${r}">${format(state['C'+r])}</span></td>
    <td class="value"><span class="cell" data-addr="D${r}">${format(state['D'+r])}</span></td>
    <td class="value"><span class="cell" data-addr="E${r}">${format(state['E'+r])}</span></td>
    <td class="value"><span class="cell" data-addr="F${r}">${format(state['F'+r])}</span></td>
    <td class="value"><span class="cell" data-addr="G${r}">${format(state['G'+r])}</span></td>`;
  tbody.appendChild(tr);
}

// utils
function format(v){ return (v==null || Number.isNaN(v)) ? '' : String(v); }
function updateCalcValues(){ document.querySelectorAll('span.cell').forEach(el => { el.textContent = format(state[el.dataset.addr]); }); }
function drawKpis(){
  const box = document.getElementById('kpis'); box.innerHTML='';
  for (const [title, addr] of Object.entries(model.kpis)){
    const v = state[addr]; const txt = format(v);
    const div = document.createElement('div');
    div.className='kpi'; div.innerHTML = `<div class="name">${title}</div><div class="val">${txt}</div>`;
    box.appendChild(div);
  }
}
function autosizeC(){
  const meas = document.getElementById('measure-span') || (()=>{const s=document.createElement('span');s.id='measure-span';s.style.cssText='position:absolute;left:-9999px;top:-9999px;white-space:pre;font:14px Inter';document.body.appendChild(s);return s;})();
  let max = 80;
  document.querySelectorAll('input.cell[data-addr^="C"]').forEach(el=>{ meas.textContent = el.value || el.placeholder || ''; max = Math.max(max, meas.getBoundingClientRect().width + 28); });
  document.querySelectorAll('span.cell[data-addr^="C"]').forEach(el=>{ meas.textContent = el.textContent || ''; max = Math.max(max, meas.getBoundingClientRect().width + 24); });
  document.getElementById('colC_inputs').style.minWidth = Math.ceil(max)+'px';
  document.getElementById('colC_calc').style.minWidth   = Math.ceil(max)+'px';
}
function resetDefaults(){ document.querySelectorAll('input.cell').forEach(inp=>{ inp.value=''; state[inp.dataset.addr]=null; }); drawKpis(); autosizeC(); }

// свернуть/развернуть блок 3
const toggleBtn = document.getElementById('toggleDetails');
const detailsBody = document.getElementById('detailsBody');
let collapsed = false;
toggleBtn.addEventListener('click', () => {
  collapsed = !collapsed;
  detailsBody.style.display = collapsed ? 'none' : 'block';
  toggleBtn.textContent = collapsed ? 'Развернуть' : 'Свернуть';
});

// экспорт PDF
async function exportToPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  const elem = document.querySelector('.container');
  const canvas = await html2canvas(elem,{scale:2});
  const img = canvas.toDataURL('image/png');
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const ratio = img.width/img.height;
  const imgWidth = pageWidth-40;
  const imgHeight = imgWidth/ratio;
  doc.addImage(img,'PNG',20,20,imgWidth,imgHeight);
  doc.save('ekoniva_calc.pdf');
}

// init
drawKpis(); autosizeC();
</script>
</body>
</html>


